# Диагностика проблем с генерацией карты сайта

## Проблема
При регенерации карты сайта на удаленном сервере возникает ошибка:
```
Не удалось регенерировать карту сайта: Artisan command failed with exit code: 1
```

## Диагностика

### 1. Запустите команду диагностики
```bash
php artisan sitemap:test-env
```

Эта команда проверит:
- Настройку APP_URL
- Права доступа к директории public
- Подключение к базе данных
- Существование view файлов
- Возможность записи файлов

### 2. Проверьте логи
```bash
tail -f storage/logs/laravel.log | grep -i sitemap
```

### 3. Запустите команду генерации вручную
```bash
php artisan sitemap:generate --force
```

## Возможные причины и решения

### 1. APP_URL не настроен
**Проблема:** В .env файле не указан APP_URL или указан неверно

**Решение:**
```bash
# В .env файле добавьте или исправьте:
APP_URL=https://yourdomain.com
```

### 2. Права доступа к директории public
**Проблема:** Нет прав на запись в директорию public

**Решение:**
```bash
# Установите правильные права
chmod 755 public/
chown www-data:www-data public/

# Или для shared hosting
chmod 777 public/
```

### 3. Проблемы с базой данных
**Проблема:** Нет подключения к базе данных или отсутствуют таблицы

**Решение:**
```bash
# Проверьте подключение
php artisan migrate:status

# Выполните миграции если нужно
php artisan migrate
```

### 4. Отсутствуют view файлы
**Проблема:** Не найдены шаблоны sitemap

**Решение:**
Убедитесь, что существуют файлы:
- `resources/views/sitemap/xml.blade.php`
- `resources/views/sitemap/html.blade.php`

### 5. Проблемы с кешем
**Проблема:** Устаревший кеш маршрутов или конфигурации

**Решение:**
```bash
# Очистите все кеши
php artisan cache:clear
php artisan config:clear
php artisan route:clear
php artisan view:clear

# Пересоздайте кеши
php artisan config:cache
php artisan route:cache
```

### 6. Проблемы с памятью или временем выполнения
**Проблема:** Недостаточно памяти или времени для выполнения команды

**Решение:**
```bash
# Увеличьте лимиты в php.ini
memory_limit = 512M
max_execution_time = 300

# Или запустите с увеличенными лимитами
php -d memory_limit=512M artisan sitemap:generate --force
```

## Улучшенная диагностика

В команду `GenerateSitemap` добавлены улучшения:

1. **Проверка требований** - проверяет APP_URL и права доступа
2. **Детальное логирование** - записывает подробную информацию об ошибках
3. **Пошаговый вывод** - показывает прогресс выполнения
4. **Обработка ошибок** - отдельная обработка для XML и HTML генерации

## Проверка на production сервере

### 1. Проверьте переменные окружения
```bash
php artisan config:show app.url
php artisan config:show database
```

### 2. Проверьте права файловой системы
```bash
ls -la public/
touch public/test.txt && rm public/test.txt
```

### 3. Проверьте логи веб-сервера
```bash
# Для Apache
tail -f /var/log/apache2/error.log

# Для Nginx
tail -f /var/log/nginx/error.log
```

## Альтернативное решение

Если проблема не решается, можно использовать альтернативный подход:

1. Генерировать карты сайта через HTTP контроллер
2. Использовать очередь для генерации
3. Создать отдельный скрипт для генерации

## Мониторинг

Для предотвращения проблем в будущем:

1. Настройте мониторинг логов
2. Добавьте проверку в health check
3. Настройте уведомления об ошибках

## Контакты

Если проблема не решается, проверьте:
1. Версию PHP (требуется 8.1+)
2. Расширения PHP (xml, dom, libxml)
3. Настройки shared hosting
4. Ограничения хостинг-провайдера