# Диагностика проблем с Telegram на удаленном сервере

## Проблема
На локальном сервере Telegram уведомления работают, на удаленном - нет, хотя ошибки не возникает.

## Возможные причины

### 1. Проблемы с переменными окружения
- Переменные `TELEGRAM_BOT_TOKEN` и `TELEGRAM_CHAT_ID` не установлены в `.env` файле на удаленном сервере
- Кэш конфигурации не обновлен после изменения `.env`

### 2. Сетевые ограничения
- Удаленный сервер блокирует исходящие HTTPS запросы
- Firewall блокирует доступ к api.telegram.org
- Провайдер хостинга ограничивает внешние API вызовы

### 3. Проблемы с SSL/TLS
- Устаревшие SSL сертификаты
- Неправильная конфигурация cURL

### 4. Таймауты и лимиты
- Слишком короткий таймаут для HTTP запросов
- Ограничения по времени выполнения скрипта

## Диагностика

### Шаг 1: Проверка через веб-интерфейс
Перейдите на: `https://your-domain.com/test-telegram`

Это покажет:
- Установлены ли переменные окружения
- Валиден ли токен бота
- Можно ли отправить тестовое сообщение

### Шаг 2: Проверка через консоль
Выполните на сервере:
```bash
php artisan telegram:test
```

Эта команда покажет детальную информацию о:
- Переменных окружения
- Соединении с Telegram API
- Отправке тестового сообщения

### Шаг 3: Проверка логов
Проверьте логи Laravel:
```bash
tail -f storage/logs/laravel.log
```

Теперь в логах будет детальная информация о каждой попытке отправки в Telegram.

### Шаг 4: Проверка переменных окружения
```bash
# Проверить, что переменные установлены
grep TELEGRAM .env

# Очистить кэш конфигурации
php artisan config:clear
php artisan config:cache
```

### Шаг 5: Проверка сетевого соединения
```bash
# Проверить доступность Telegram API
curl -I https://api.telegram.org

# Проверить с токеном бота
curl "https://api.telegram.org/bot<YOUR_BOT_TOKEN>/getMe"
```

## Решения

### Если проблема в переменных окружения:
1. Убедитесь, что `.env` файл содержит правильные значения
2. Выполните `php artisan config:clear`
3. Перезапустите веб-сервер

### Если проблема в сетевых ограничениях:
1. Обратитесь к провайдеру хостинга
2. Проверьте настройки firewall
3. Рассмотрите использование прокси или VPN

### Если проблема в SSL:
1. Обновите CA сертификаты на сервере
2. Добавьте в HTTP клиент опцию `verify => false` (только для тестирования!)

### Если проблема в таймаутах:
1. Увеличьте таймаут в методе `sendTelegramNotification`
2. Проверьте настройки `max_execution_time` в PHP

## Улучшения в коде

В обновленном коде добавлены:

1. **Детальное логирование** - каждая попытка отправки записывается в лог
2. **Проверка ответа API** - код проверяет успешность запроса
3. **Таймаут** - установлен таймаут 30 секунд для HTTP запросов
4. **Тестовый метод** - `testTelegramConnection()` для диагностики
5. **Консольная команда** - `php artisan telegram:test` для проверки из командной строки
6. **Веб-маршрут** - `/test-telegram` для проверки через браузер

## Безопасность

⚠️ **Важно**: После решения проблемы удалите или защитите тестовые маршруты:

```php
// Удалите или закомментируйте в routes/web.php
Route::get('/test-telegram', ...);
```

Или добавьте middleware для ограничения доступа:

```php
Route::get('/test-telegram', ...)->middleware('auth');
```